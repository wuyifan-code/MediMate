<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è°æ˜¯å§åº• - èšä¼šæ¸¸æˆ (RTDBç‰ˆ)</title>

    <!-- é¢„è¿æ¥å›½å†… CDN åŠ é€Ÿç•Œé¢åŠ è½½ -->
    <link rel="preconnect" href="https://cdn.staticfile.net">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. å¼•å…¥ React å’Œ ReactDOM (å›½å†…æº) -->
    <script src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- 3. å¼•å…¥ Babel (å›½å†…æº) -->
    <script src="https://cdn.staticfile.net/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            touch-action: manipulation;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #app-loading {
            position: fixed;
            inset: 0;
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #9333ea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .loading-text {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div id="app-loading">
        <div class="spinner"></div>
        <div class="loading-text">èµ„æºåŠ è½½ä¸­...</div>
    </div>

    <div id="root"></div>

    <!-- 4. æ¸¸æˆé€»è¾‘ä»£ç  (åˆ‡æ¢ä¸º Realtime Database) -->
    <script type="text/babel" data-type="module">
        // ä½¿ç”¨å®˜æ–¹ ES Moduleï¼Œä½†åˆ‡æ¢åˆ° Realtime Database æ¨¡å—
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // æ³¨æ„ï¼šè¿™é‡Œå¯¼å…¥çš„æ˜¯ firebase-database.js è€Œä¸æ˜¯ firestore
        import { getDatabase, ref, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const { useState, useEffect } = React;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const Icon = ({ path, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {path}
            </svg>
        );
        const Icons = {
            EyeOff: (p) => <Icon {...p} path={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.8 0 1.6-.1 2.35-.29" /><path d="M2 2l20 20" /></>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>} />,
            Skull: (p) => <Icon {...p} path={<><path d="m12.5 17-.5-1-.5 1h1z" /><path d="M15 22a1 1 0 0 0 1-1v-1a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 19v1a1 1 0 0 0 1 1h6z" /><circle cx="15" cy="12" r="1" /><circle cx="9" cy="12" r="1" /></>} />,
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3" />} />,
            RotateCcw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></>} />,
            Plus: (p) => <Icon {...p} path={<><path d="M5 12h14" /><path d="M12 5v14" /></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></>} />,
            Crown: (p) => <Icon {...p} path={<path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" />} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></>} />,
            AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></>} />,
        };

        const DEFAULT_PLAYERS_LIST = ['äºå®', 'å¼ å©‰è‹—', 'èƒ¡æ¬£é›…', 'ä¼ä¸€å¸†', 'é™ˆé›', 'é™ˆæ€åŒ'];
        const DEFAULT_ADMIN_NAME = 'èµµä¹…æ‰¬';
        const DEFAULT_WORD_PAIRS = [
            { undercover: 'æ£ºæ', civilian: 'åºŠ' },
            { undercover: 'è‘¬ç¤¼', civilian: 'å©šç¤¼' },
            { undercover: 'éª¨ç°', civilian: 'å¥¶ç²‰' },
            { undercover: 'ç™½é…’', civilian: 'çº¢é…’' },
            { undercover: 'ä¸Šå­¦', civilian: 'åç‰¢' },
            { undercover: 'å¯ä¹', civilian: 'é›ªç¢§' },
            { undercover: 'èœ˜è››ä¾ ', civilian: 'è™è ä¾ ' }
        ];

        // --- Firebase é…ç½® (åŒ…å« databaseURL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLeUHDLnxpd05HnioDdtOPKa5kMW4LQCE",
            authDomain: "wuyifan-code04.firebaseapp.com",
            databaseURL: "https://wuyifan-code04-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wuyifan-code04",
            storageBucket: "wuyifan-code04.firebasestorage.app",
            messagingSenderId: "1048037918553",
            appId: "1:1048037918553:web:7df33e507c7a363377ae48",
            measurementId: "G-SR8GNYN2WG"
        };

        // åˆå§‹åŒ– - ä½¿ç”¨ Realtime Database
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const GAME_REF_PATH = 'spy_game_rooms/room_1';

        function App() {
            const [myIdentity, setMyIdentity] = useState(() => localStorage.getItem('spy_game_identity') || null);
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isRevealing, setIsRevealing] = useState(false);

            // Admin inputs
            const [adminCustomCivilian, setAdminCustomCivilian] = useState('');
            const [adminCustomUndercover, setAdminCustomUndercover] = useState('');

            // Config inputs
            const [isConfiguring, setIsConfiguring] = useState(false);
            const [tempAdminName, setTempAdminName] = useState('');
            const [tempPlayers, setTempPlayers] = useState([]);
            const [newPlayerName, setNewPlayerName] = useState('');

            // ç§»é™¤åŠ è½½åŠ¨ç”»
            useEffect(() => {
                const loader = document.getElementById('app-loading');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            }, []);

            // --- æ ¸å¿ƒé€»è¾‘ï¼šç›‘å¬ Realtime Database ---
            useEffect(() => {
                // æ— éœ€ç™»å½•ï¼Œç›´æ¥ç›‘å¬æ•°æ®
                const roomRef = ref(db, GAME_REF_PATH);

                const unsubscribe = onValue(roomRef, (snapshot) => {
                    setLoading(false);
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        setGameData(data);
                        // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œè‡ªåŠ¨åˆå§‹åŒ–é»˜è®¤é…ç½®
                        if (!data.config) {
                            update(roomRef, {
                                config: {
                                    adminName: DEFAULT_ADMIN_NAME,
                                    playersList: DEFAULT_PLAYERS_LIST
                                }
                            });
                        }
                    } else {
                        // å¦‚æœæˆ¿é—´ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆå§‹åŒ–
                        const initialData = {
                            status: 'setup',
                            roundId: 1,
                            currentWordPair: null,
                            players: {},
                            config: {
                                adminName: DEFAULT_ADMIN_NAME,
                                playersList: DEFAULT_PLAYERS_LIST
                            }
                        };
                        set(roomRef, initialData).catch(err => {
                            console.error("åˆå§‹åŒ–å¤±è´¥", err);
                            setError("æ— æ³•å†™å…¥æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥è§„åˆ™æ˜¯å¦å…è®¸å…¬å¼€å†™å…¥");
                        });
                    }
                }, (err) => {
                    console.error("è¿æ¥é”™è¯¯:", err);
                    setLoading(false);
                    setError("æ— æ³•è¿æ¥æ•°æ®åº“ã€‚å¦‚æœä½¿ç”¨å›½å†…ç½‘ç»œï¼Œè¯·å°è¯•å¼€å¯ä»£ç†ã€‚");
                });

                return () => unsubscribe(); // æ¸…ç†ç›‘å¬
            }, []);

            // --- æ´¾ç”ŸçŠ¶æ€ ---
            const playersList = gameData?.config?.playersList || DEFAULT_PLAYERS_LIST;
            const adminName = gameData?.config?.adminName || DEFAULT_ADMIN_NAME;

            // --- åŠ¨ä½œå‡½æ•° ---

            const handleSelectIdentity = (name) => {
                setMyIdentity(name);
                localStorage.setItem('spy_game_identity', name);
            };

            const handleLogout = () => {
                setMyIdentity(null);
                localStorage.removeItem('spy_game_identity');
            };

            // é…ç½®ç®¡ç†
            const openConfig = () => {
                setTempAdminName(adminName);
                setTempPlayers([...playersList]);
                setIsConfiguring(true);
            };

            const handleAddPlayer = () => {
                if (newPlayerName.trim() && !tempPlayers.includes(newPlayerName.trim())) {
                    setTempPlayers([...tempPlayers, newPlayerName.trim()]);
                    setNewPlayerName('');
                }
            };

            const handleRemovePlayer = (name) => {
                setTempPlayers(tempPlayers.filter(p => p !== name));
            };

            const handleSaveConfig = async () => {
                if (!tempAdminName.trim() || tempPlayers.length < 3) {
                    alert("è¯·è®¾ç½®æœ‰æ•ˆçš„ç®¡ç†å‘˜åç§°ï¼Œä¸”è‡³å°‘éœ€è¦3åç©å®¶");
                    return;
                }
                try {
                    await update(ref(db, GAME_REF_PATH + '/config'), {
                        adminName: tempAdminName.trim(),
                        playersList: tempPlayers
                    });
                    setIsConfiguring(false);
                } catch (err) {
                    alert("ä¿å­˜é…ç½®å¤±è´¥: " + err.message);
                }
            };

            // ç®¡ç†å‘˜ï¼šå¼€å§‹/ä¸‹ä¸€è½®
            const handleStartGame = async (customPair = null) => {
                let selectedPair = customPair;
                if (!selectedPair) {
                    const randomIdx = Math.floor(Math.random() * DEFAULT_WORD_PAIRS.length);
                    selectedPair = DEFAULT_WORD_PAIRS[randomIdx];
                }

                // åˆ†é…èº«ä»½
                let roles = Array(playersList.length).fill('civilian');
                roles[0] = 'undercover';
                // æ´—ç‰Œ (Fisher-Yates)
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }

                const newPlayersMap = {};
                playersList.forEach((name, index) => {
                    newPlayersMap[name] = {
                        role: roles[index],
                        word: roles[index] === 'undercover' ? selectedPair.undercover : selectedPair.civilian,
                        viewed: false
                    };
                });

                // å†™å…¥ RTDB
                const updates = {
                    status: 'playing',
                    currentWordPair: selectedPair,
                    players: newPlayersMap,
                    roundId: (gameData?.roundId || 0) + 1
                };

                try {
                    await update(ref(db, GAME_REF_PATH), updates);
                } catch (err) {
                    alert("æ“ä½œå¤±è´¥: " + err.message);
                }
            };

            const handleRevealAll = () => {
                update(ref(db, GAME_REF_PATH), { status: 'revealed' });
            };

            // ç©å®¶ï¼šæŸ¥çœ‹è¯æ±‡
            const handleViewWord = () => {
                if (!gameData || !myIdentity) return;
                // RTDB æ›´æ–°è·¯å¾„: players/å§“å/viewed
                update(ref(db, `${GAME_REF_PATH}/players/${myIdentity}`), { viewed: true });
            };

            // --- çŠ¶æ€æŒ‡ç¤ºå™¨ ---
            const StatusBadge = () => (
                <div className={`flex items-center gap-1.5 px-2 py-1 rounded-full text-[10px] font-medium border transition-colors ${error ? 'bg-red-50 text-red-600 border-red-100' :
                        'bg-emerald-50 text-emerald-600 border-emerald-100'
                    }`}>
                    <span className={`w-1.5 h-1.5 rounded-full ${error ? 'bg-red-500' : 'bg-emerald-500'}`}></span>
                    {error ? 'ç¦»çº¿' : 'åœ¨çº¿ (RTDB)'}
                </div>
            );

            // --- ç•Œé¢æ¸²æŸ“ ---

            if (loading) return null; // Loading handled by CSS

            // é”™è¯¯ç•Œé¢
            if (error) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-red-50 p-6 text-center">
                    <div className="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full border border-red-100">
                        <Icons.AlertTriangle className="mx-auto text-red-500 w-12 h-12 mb-4" />
                        <h2 className="text-xl font-bold text-slate-800 mb-2">è¿æ¥å¤±è´¥</h2>
                        <p className="text-red-600 bg-red-50 p-3 rounded mb-4 text-sm">{error}</p>
                        <button onClick={() => window.location.reload()} className="w-full py-3 bg-red-600 text-white rounded-xl font-bold">é‡è¯•</button>
                    </div>
                </div>
            );

            // é…ç½®ç•Œé¢
            if (isConfiguring) {
                return (
                    <div className="min-h-screen bg-slate-50 p-4 flex flex-col items-center justify-center animate-fade-in">
                        <div className="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full border border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <Icons.Settings size={24} /> æ¸¸æˆè®¾ç½®
                            </h2>

                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">æœ€é«˜æ§åˆ¶å‘˜ (ç®¡ç†å‘˜)</label>
                                    <div className="flex gap-2">
                                        <div className="p-3 bg-slate-100 rounded-xl flex items-center justify-center text-slate-500">
                                            <Icons.Crown size={20} />
                                        </div>
                                        <input
                                            value={tempAdminName}
                                            onChange={e => setTempAdminName(e.target.value)}
                                            className="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-purple-500"
                                            placeholder="è¾“å…¥ç®¡ç†å‘˜åå­—"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">ç©å®¶åˆ—è¡¨ ({tempPlayers.length}äºº)</label>
                                    <div className="flex gap-2 mb-2">
                                        <input
                                            value={newPlayerName}
                                            onChange={e => setNewPlayerName(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && handleAddPlayer()}
                                            className="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-purple-500"
                                            placeholder="è¾“å…¥æ–°ç©å®¶åå­—"
                                        />
                                        <button onClick={handleAddPlayer} className="p-3 bg-purple-100 text-purple-600 rounded-xl font-bold hover:bg-purple-200 transition-colors">
                                            <Icons.Plus size={20} />
                                        </button>
                                    </div>
                                    <div className="flex flex-wrap gap-2 max-h-48 overflow-y-auto p-1">
                                        {tempPlayers.map(name => (
                                            <div key={name} className="flex items-center gap-1 px-3 py-1.5 bg-slate-100 rounded-lg text-sm text-slate-700 group">
                                                <span>{name}</span>
                                                <button onClick={() => handleRemovePlayer(name)} className="text-slate-400 hover:text-red-500 ml-1">
                                                    <Icons.Trash2 size={14} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button onClick={() => setIsConfiguring(false)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
                                <button onClick={handleSaveConfig} className="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-colors shadow-lg">ä¿å­˜é…ç½®</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // 1. ç™»å½•/é€‰äººç•Œé¢
            if (!myIdentity) {
                return (
                    <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center animate-fade-in relative">
                        <div className="absolute top-4 right-4 flex items-center gap-2">
                            <StatusBadge />
                            <button onClick={openConfig} className="p-2 bg-white rounded-full shadow-sm text-slate-400 hover:text-slate-600 transition-colors">
                                <Icons.Settings size={18} />
                            </button>
                        </div>
                        <div className="text-6xl mb-6">ğŸ•µï¸</div>
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">ä½ æ˜¯è°ï¼Ÿ</h1>
                        <div className="w-full max-w-md grid grid-cols-2 gap-3 mt-6">
                            {playersList.map(name => (
                                <button key={name} onClick={() => handleSelectIdentity(name)} className="p-4 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 shadow-sm hover:border-purple-500 hover:text-purple-600 active:scale-95 transition-all">{name}</button>
                            ))}
                            <button onClick={() => handleSelectIdentity(adminName)} className="col-span-2 mt-4 p-4 bg-slate-800 text-yellow-500 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 active:scale-95 transition-all">
                                <Icons.Crown size={20} /> ç®¡ç†å‘˜ {adminName}
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. ç®¡ç†å‘˜ç•Œé¢
            if (myIdentity === adminName) {
                return (
                    <div className="min-h-screen bg-slate-100 p-4 pb-20">
                        <header className="bg-white p-4 rounded-xl shadow-sm mb-6 flex justify-between items-center sticky top-0 z-10">
                            <div>
                                <h1 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Crown size={20} className="text-yellow-500" /> æ§åˆ¶å°</h1>
                                <p className="text-xs text-slate-400">çŠ¶æ€: {gameData?.status === 'playing' ? 'æ¸¸æˆä¸­' : 'å‡†å¤‡ä¸­'}</p>
                            </div>
                            <div className="flex items-center gap-3"><StatusBadge /><button onClick={handleLogout} className="text-slate-400"><Icons.LogOut size={20} /></button></div>
                        </header>
                        <div className="space-y-6 max-w-md mx-auto">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h2 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.Settings size={18} /> è¿›ç¨‹æ§åˆ¶</h2>
                                <div className="space-y-3">
                                    <button onClick={() => handleStartGame(null)} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-slate-800 active:scale-95 transition-all flex items-center justify-center gap-2">
                                        <Icons.Play size={20} /> {gameData?.status === 'setup' ? 'å¼€å§‹ç¬¬ä¸€è½® (éšæœº)' : 'ä¸‹ä¸€è½® (åˆ·æ–°)'}
                                    </button>
                                    {gameData?.status === 'playing' && (
                                        <button onClick={handleRevealAll} className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold hover:bg-red-200 transition-all">ç»“æŸæœ¬å±€å¹¶æ˜¾ç¤º</button>
                                    )}
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h2 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.Plus size={18} /> è‡ªå®šä¹‰è¯æ±‡</h2>
                                <div className="grid grid-cols-2 gap-3 mb-4">
                                    <input value={adminCustomCivilian} onChange={e => setAdminCustomCivilian(e.target.value)} placeholder="å¹³æ°‘è¯" className="p-3 bg-slate-50 rounded-lg border text-sm" />
                                    <input value={adminCustomUndercover} onChange={e => setAdminCustomUndercover(e.target.value)} placeholder="å§åº•è¯" className="p-3 bg-slate-50 rounded-lg border text-sm" />
                                </div>
                                <button onClick={() => handleStartGame({ civilian: adminCustomCivilian, undercover: adminCustomUndercover })} disabled={!adminCustomCivilian || !adminCustomUndercover} className="w-full bg-purple-100 text-purple-700 py-3 rounded-xl font-bold disabled:opacity-50">ä½¿ç”¨è‡ªå®šä¹‰è¯æ±‡</button>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h2 className="font-bold text-slate-700 mb-4">ç©å®¶çŠ¶æ€</h2>
                                <div className="grid grid-cols-2 gap-2">
                                    {playersList.map(name => {
                                        const p = gameData?.players?.[name];
                                        return (
                                            <div key={name} className="flex items-center justify-between p-2 bg-slate-50 rounded-lg text-xs">
                                                <span className="font-bold text-slate-600">{name}</span>
                                                {p?.viewed ? <span className="text-green-600 flex items-center gap-1"><Icons.CheckCircle size={12} /> å·²çœ‹</span> : <span className="text-slate-400">æœªçœ‹</span>}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 3. ç©å®¶ç•Œé¢
            const myPlayerData = gameData?.players?.[myIdentity];
            const isPlaying = gameData?.status === 'playing';
            const isRevealed = gameData?.status === 'revealed';

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 selection:bg-purple-200">
                    <header className="bg-white shadow-sm sticky top-0 z-10 px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2"><span className="text-2xl">ğŸ˜ˆ</span><div><h1 className="text-sm font-bold text-slate-800">è°æ˜¯å§åº•</h1><p className="text-xs text-slate-400">æˆ‘æ˜¯: <span className="font-bold text-purple-600">{myIdentity}</span></p></div></div>
                        <div className="flex items-center gap-3"><StatusBadge /><button onClick={handleLogout} className="text-xs text-slate-400 underline">åˆ‡æ¢</button></div>
                    </header>
                    <main className="max-w-md mx-auto px-4 py-8 relative">
                        {gameData?.status === 'setup' && (
                            <div className="flex flex-col items-center justify-center py-20 text-center animate-fade-in space-y-6">
                                <div className="text-6xl animate-bounce">â³</div>
                                <div><h2 className="text-xl font-bold text-slate-700">ç­‰å¾…æ¸¸æˆå¼€å§‹</h2><p className="text-slate-400 text-sm mt-2">è¯·ç­‰å¾…ç®¡ç†å‘˜ {adminName} å‘ç‰Œ...</p></div>
                                <div className="bg-white p-4 rounded-xl shadow-sm w-full max-w-xs"><p className="text-xs text-slate-400 mb-2">åœ¨çº¿ç©å®¶</p><div className="flex flex-wrap gap-2 justify-center">{playersList.map(name => (<span key={name} className="text-xs px-2 py-1 bg-slate-100 rounded text-slate-500">{name}</span>))}</div></div>
                            </div>
                        )}
                        {isPlaying && myPlayerData && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="text-center"><h2 className="text-2xl font-bold text-slate-800">ç¬¬ {gameData.roundId} è½®</h2><p className="text-slate-500 text-sm">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡æŸ¥çœ‹ä½ çš„è¯æ±‡</p></div>
                                <div className="relative h-64 w-full bg-white rounded-2xl shadow-xl flex items-center justify-center cursor-pointer select-none overflow-hidden group border border-slate-100 transition-all active:scale-95" onMouseDown={() => { setIsRevealing(true); handleViewWord(); }} onMouseUp={() => setIsRevealing(false)} onTouchStart={() => { setIsRevealing(true); handleViewWord(); }} onTouchEnd={() => setIsRevealing(false)}>
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center bg-slate-800 transition-opacity duration-300 ${isRevealing ? 'opacity-0' : 'opacity-100'}`}>
                                        <div className="bg-slate-700 p-4 rounded-full mb-4 group-hover:bg-slate-600 transition-colors"><Icons.EyeOff size={48} className="text-slate-300" /></div>
                                        <span className="text-slate-300 font-bold text-lg">æŒ‰ä½æŸ¥çœ‹è¯æ±‡</span>
                                    </div>
                                    <div className={`absolute inset-0 flex flex-col items-center justify-center bg-purple-600 transition-opacity duration-100 ${isRevealing ? 'opacity-100' : 'opacity-0'}`}>
                                        <span className="text-4xl font-bold text-white tracking-widest animate-pulse">{myPlayerData.word}</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 mt-8">
                                    {playersList.filter(n => n !== myIdentity).map(name => {
                                        const p = gameData.players[name];
                                        return <div key={name} className={`p-3 rounded-xl border flex items-center justify-between ${p?.viewed ? 'bg-slate-50 border-slate-200' : 'bg-white border-dashed border-slate-300'}`}><span className="text-sm font-bold text-slate-600">{name}</span>{p?.viewed ? <Icons.CheckCircle size={16} className="text-green-500" /> : <span className="text-[10px] bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full">æŸ¥çœ‹ä¸­...</span>}</div>
                                    })}
                                </div>
                            </div>
                        )}
                        {isRevealed && (
                            <div className="space-y-6 animate-fade-in pb-20">
                                <div className="text-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                    <h2 className="text-xl font-bold text-slate-800 mb-4">æœ¬å±€çœŸç›¸</h2>
                                    <div className="flex items-center justify-center gap-8">
                                        <div className="text-center"><div className="text-xs text-slate-400 uppercase mb-1">å¹³æ°‘è¯</div><div className="text-xl font-bold text-green-600">{gameData.currentWordPair?.civilian}</div></div>
                                        <div className="w-px h-10 bg-slate-200"></div>
                                        <div className="text-center"><div className="text-xs text-slate-400 uppercase mb-1">å§åº•è¯</div><div className="text-xl font-bold text-red-600">{gameData.currentWordPair?.undercover}</div></div>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    {playersList.map(name => {
                                        const p = gameData.players?.[name];
                                        const isUndercover = p?.role === 'undercover';
                                        return (
                                            <div key={name} className={`flex items-center justify-between p-4 rounded-xl border ${isUndercover ? 'bg-red-50 border-red-100' : 'bg-white border-slate-100'}`}>
                                                <div className="flex items-center gap-3"><span className="font-bold text-slate-700">{name}</span><span className="text-xs text-slate-500 bg-white/50 px-2 py-0.5 rounded">æ‹¿åˆ°äº†: {p?.word}</span></div>
                                                {isUndercover && <span className="text-sm font-bold text-red-600 flex items-center gap-1"><Icons.Skull size={14} /> å§åº•</span>}
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="text-center text-slate-400 text-sm mt-8 animate-pulse">ç­‰å¾…ç®¡ç†å‘˜å¼€å¯ä¸‹ä¸€å±€...</div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>